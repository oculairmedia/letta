services:
  redis:
    image: redis:7-alpine
    healthcheck:
      test:
        - CMD
        - redis-cli
        - ping
      interval: 5s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - letta-network
  postgres:
    image: pgvector/pgvector:pg15
    environment:
      POSTGRES_USER: letta
      POSTGRES_PASSWORD: letta
      POSTGRES_DB: letta
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 1GB
    volumes:
      - type: bind
        source: ${HOME}/.letta/.persist/pgdata
        target: /var/lib/postgresql/data
    ports:
      - 5432:5432
    deploy:
      resources:
        limits:
          memory: 2048M
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U letta -d letta
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - letta-network
  llmux-openai-shim:
    image: ghcr.io/oculairmedia/letta:latest
    command:
      - python
      - /shim/server.py
    environment:
      - LLMUX_UPSTREAM_BASE_URL=http://192.168.50.90:8082
      - GEMINI_UPSTREAM_BASE_URL=http://192.168.50.90:8089
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ZAI_UPSTREAM_BASE_URL=https://api.z.ai/api/paas/v4
      - ZAI_CODING_UPSTREAM_BASE_URL=https://api.z.ai/api/coding/paas/v4
      - ZAI_API_KEY=${ZAI_API_KEY}
      - ZAI_MODEL_IDS=glm-4.7
      - PORT=8090
    volumes:
      - ./llmux_shim:/shim:ro
    networks:
      - letta-network
  letta:
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      llmux-openai-shim:
        condition: service_started
    ports:
      - 8283:8283
    environment:
      - LETTA_SERVER_PASSWORD=lettaSecurePass123
      - DATABASE_URL=postgresql://letta:letta@postgres:5432/letta
      - LETTA_PG_URI=postgresql://letta:letta@postgres:5432/letta
      - LETTA_PG_DB=letta
      - LETTA_PG_USER=letta
      - LETTA_PG_PASSWORD=letta
      - LETTA_PG_HOST=postgres
      - LETTA_PG_PORT=5432
      - LETTA_REDIS_HOST=redis
      - LETTA_REDIS_PORT=6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - TOGETHER_API_KEY=${TOGETHER_API_KEY}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL}
      - VLLM_API_BASE=${VLLM_API_BASE}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - COMPOSIO_API_KEY=${COMPOSIO_API_KEY}
      - LETTA_WEBHOOK_ALLOWED_HOSTS=["192.168.50.90"]
      - LETTA_WEBHOOK_GLOBAL_URL=http://192.168.50.90:8020/webhook/letta
    env_file:
      - .env
    image: ghcr.io/oculairmedia/letta:latest
    labels:
      - homepage.group=AI & Automation
      - homepage.name=Letta
      - homepage.icon=openai.png
      - homepage.href=https://app.letta.com
      - homepage.description=AI Agent Platform
      - homepage.weight=30
    deploy:
      resources:
        limits:
          memory: 4096M
    networks:
      - letta-network
networks:
  letta-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
